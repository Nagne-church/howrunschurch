<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장로교회 정치원리: 대화형 학습</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .chapter-title { font-size: 1.75rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 3px solid #4f46e5; color: #1e1b4b; display: flex; align-items: center; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }
        #modal-overlay.hidden { display: none; }
        .chat-bubble-user { background-color: #4f46e5; color: white; }
        .chat-bubble-bot { background-color: #e5e7eb; color: #1f2937; }
        .summary-content h3 { font-size: 1.2rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: 0.75rem; color: #312e81; padding-bottom: 4px; border-bottom: 1px solid #c7d2fe; }
        .summary-content p, .summary-content li { color: #374151; line-height: 1.8; margin-bottom: 1rem; }
        .summary-content ul { list-style-type: '✓ '; list-style-position: inside; padding-left: 0.5rem; }
        .summary-content blockquote { border-left: 4px solid #818cf8; padding: 1rem; margin: 1.5rem 0; font-style: italic; color: #4b5563; background-color: #f9fafb; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="w-full max-w-5xl h-[95vh] flex flex-col bg-white rounded-2xl shadow-2xl border border-gray-200">
        <header class="bg-gradient-to-r from-indigo-700 to-indigo-900 text-white p-5 rounded-t-2xl shadow-lg flex-shrink-0">
            <h1 class="text-3xl font-bold text-center">장로교회 정치원리: 대화형 학습</h1>
            <p class="text-md text-center text-indigo-200 mt-1">"예수님은 교회를 어떻게 다스리시는가" 상세 요약</p>
        </header>

        <main id="summary-panel" class="flex-1 p-6 md:p-8 overflow-y-auto custom-scrollbar">
            
            <div class="chapter-section space-y-4">
                <h2 class="chapter-title"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg>서론: 왜 교회 정치가 중요한가?</h2>
                <div class="summary-content">
                    <p>교회 정치는 단순히 행정 절차나 규칙의 문제가 아니라, 그리스도인의 제자도에 있어 핵심적인 부분입니다. 올바른 교회 정치는 교회의 머리이신 예수 그리스도의 지혜와 영광을 드러내기 때문입니다. 성경은 그리스도와 교회의 관계가 분리될 수 없음을 강조하며(엡 5:23), 교회는 그리스도의 통치가 가시적으로 나타나는 '그리스도의 왕국'(WCF 25.2)입니다. 또한, 교회는 지상대위임령(마 28:18-20)을 수행하는 유일한 기관이며, 이 사명을 감당하기 위해서는 성경적인 질서와 통치가 반드시 필요합니다. 따라서 교회 정치를 아는 것은 그리스도를 더 깊이 알고 그분의 몸 된 교회를 더 잘 섬기는 길입니다.</p>
                    <button class="ask-question-btn mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">이해를 돕는 질문하기</button>
                </div>
            </div>

            <div class="chapter-section space-y-4">
                <h2 class="chapter-title"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A11.953 11.953 0 0 1 12 13.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 0 3 12c0 .778.099 1.533.284 2.253m0 0" /></svg>제1장: 교회란 무엇인가?</h2>
                <div class="summary-content">
                    <h3>⛪ 하나님의 한 백성: 구약과 신약의 연속성</h3>
                    <p>교회는 신약 시대에 갑자기 등장한 조직이 아니라, 구약의 이스라엘로부터 이어지는 하나님의 단일한 백성입니다. 하나님은 아브라함과 맺으신 언약을 폐기하신 것이 아니라, 그리스도 안에서 그 언약을 성취하고 모든 민족에게로 확장하셨습니다. 로마서 11장의 '올리브 나무 비유'는 이를 명확히 보여줍니다. 믿지 않는 원래 가지(유대인)는 꺾이고, 그 자리에 야생 올리브 나무 가지인 이방인이 접붙여졌지만, 나무의 뿌리(아브라함 언약과 구속의 약속)는 동일합니다. 이는 교회가 구속사의 중심에 있는 하나님의 영원한 계획의 일부임을 증거합니다.</p>
                    <h3>👁️ 보이는 교회와 보이지 않는 교회</h3>
                    <p>성경은 교회를 두 가지 측면에서 설명합니다. '보이지 않는 교회'는 시간과 공간을 초월하여 오직 하나님만이 아시는 모든 시대의 택함 받은 성도들의 총합으로, 흠 없는 그리스도의 신부입니다. 반면 '보이는 교회'는 이 땅에서 참된 신앙을 공적으로 고백하는 자들과 그들의 자녀들로 구성된 제도적 교회입니다. 이 두 교회는 겹치지만 완전히 동일하지는 않습니다. 보이는 교회 안에는 알곡과 가라지가 섞여 있듯, 중생하지 않은 사람이 있을 수 있습니다. 이 구분은 교회 내에 위선과 배교가 존재할 수 있음을 설명하며, 우리가 사람의 마음을 판단할 수 없고 오직 '믿을 만한 신앙고백'을 근거로 회원을 받아야 함을 가르쳐줍니다.</p>
                    <h3>🤝 교회 회원권의 필연성과 자격</h3>
                    <p>그리스도인의 제자도에 있어 교회 회원권은 선택이 아닌 필수입니다. 신약의 수많은 "서로"라는 명령(서로 사랑하라, 서로 용납하라 등)은 구체적인 공동체 안에서의 언약적 관계를 전제합니다. 회원권은 교회의 다스림과 권징 아래 자신을 복종시키며, 성도의 교제를 통해 함께 성장하겠다는 공적인 약속입니다. 회원의 자격은 그리스도에 대한 신앙을 공적으로 고백하는 사람과, 언약의 연속성 안에서 그들의 자녀에게 주어집니다. 이것이 유아세례의 핵심적인 성경적 근거가 됩니다.</p>
                    <button class="ask-question-btn mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">이해를 돕는 질문하기</button>
                </div>
            </div>
            
            <!-- 다른 장들도 동일한 구조로 여기에 위치합니다... -->

        </main>
    </div>

    <!-- Modal for Interactive Q&A -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">질문하기</h2>
                <button id="close-modal-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </header>
            <div id="modal-chat-container" class="p-6 flex-1 overflow-y-auto custom-scrollbar"></div>
            <footer class="p-4 bg-gray-50 border-t border-gray-200">
                <div class="flex items-center">
                    <input type="text" id="modal-user-input" class="flex-1 border border-gray-300 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="질문을 입력하세요...">
                    <button id="modal-send-btn" class="ml-3 bg-indigo-600 text-white rounded-full p-3 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-indigo-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const askButtons = document.querySelectorAll('.ask-question-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalChatContainer = document.getElementById('modal-chat-container');
            const modalUserInput = document.getElementById('modal-user-input');
            const modalSendBtn = document.getElementById('modal-send-btn');

            let currentTopicContent = '';
            let currentTopicTitle = '';

            askButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const chapterSection = button.closest('.chapter-section');
                    currentTopicTitle = chapterSection.querySelector('.chapter-title').textContent.trim();
                    const summaryElement = chapterSection.querySelector('.summary-content');
                    currentTopicContent = summaryElement ? summaryElement.innerText.replace('이해를 돕는 질문하기', '').trim() : '';

                    modalTitle.textContent = `"${currentTopicTitle}" 질문하기`;
                    modalChatContainer.innerHTML = `<div class="flex justify-start mb-4"><div class="chat-bubble-bot p-3 rounded-lg max-w-lg"><p class="text-sm">안녕하세요! 선택하신 주제에 대해 궁금한 점을 질문해주세요.</p></div></div>`;
                    modalOverlay.classList.remove('hidden');
                    modalUserInput.focus();
                });
            });

            const addChatMessage = (text, sender) => {
                const bubble = document.createElement('div');
                bubble.className = `p-3 rounded-lg max-w-lg mb-2 ${sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-bot self-start'}`;
                bubble.innerHTML = `<p class="text-sm">${text}</p>`;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                messageWrapper.appendChild(bubble);
                modalChatContainer.appendChild(messageWrapper);
                modalChatContainer.scrollTop = modalChatContainer.scrollHeight;
            };

            const showTypingIndicator = () => {
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'flex justify-start mb-4';
                typingIndicator.innerHTML = `<div class="chat-bubble-bot p-3 rounded-lg"><div class="flex items-center space-x-1"><span class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span><span class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span><span class="h-2 w-2 bg-gray-400 rounded-full animate-bounce"></span></div></div>`;
                modalChatContainer.appendChild(typingIndicator);
                modalChatContainer.scrollTop = modalChatContainer.scrollHeight;
            };

            const removeTypingIndicator = () => {
                document.getElementById('typing-indicator')?.remove();
            };

            const callGeminiAPI = async (prompt) => {
                const apiUrl = '/api/ask-gemini'; 
                const payload = { prompt: prompt };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `서버 요청 실패 (상태 코드: ${response.status})`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                            return "콘텐츠 생성 정책에 따라 답변을 생성할 수 없습니다.";
                        }
                        throw new Error("API 응답 구조가 올바르지 않습니다.");
                    }
                } catch (error) {
                    console.error("API 호출 중 에러 발생:", error);
                    return `API 호출 중 오류가 발생했습니다. 이 기능을 사용하려면 서버(Netlify/Vercel)에 프로젝트가 정상적으로 배포되고 환경 변수(API 키)가 설정되어야 합니다.`;
                }
            };

            const handleModalSend = async () => {
                const question = modalUserInput.value.trim();
                if (!question) return;

                addChatMessage(question, 'user');
                modalUserInput.value = '';
                modalSendBtn.disabled = true;
                showTypingIndicator();

                try {
                    const prompt = \`당신은 개혁신학(Reformed Theology)에 정통한 신학자이자 '장로교회 정치원리' 전문가입니다. 사용자의 질문에 대해, 먼저 아래에 주어진 책의 요약 내용에 충실하게 답변해야 합니다. 그리고 개혁신학의 관점에서 내용을 보충하거나 신학적 의미를 더 깊이 설명하여 답변을 풍성하게 만들어 주세요. 예를 들어, 언약 신학, 하나님의 주권, 은혜의 방편 등의 개념을 활용할 수 있습니다. 답변은 항상 한국어로, 전문적이면서도 이해하기 쉬운 어조로 작성해주세요. 만약 주어진 요약 내용과 관련 없는 질문이라면, "선택하신 주제와 관련된 질문을 해주시면, 개혁신학의 관점에서 더 깊이 있는 답변을 드리겠습니다."라고 안내해주세요.\n\n### 주제: \${currentTopicTitle}\n\n### 요약 내용:\n\${currentTopicContent}\n\n### 사용자 질문: "\${question}"\`;
                    const botResponse = await callGeminiAPI(prompt);
                    removeTypingIndicator();
                    addChatMessage(botResponse.replace(/\n/g, '<br>'), 'bot');
                } catch (error) {
                    removeTypingIndicator();
                    console.error('Error:', error);
                    addChatMessage("오류가 발생했습니다. 잠시 후 다시 시도해주세요.", 'bot');
                } finally {
                    modalSendBtn.disabled = false;
                    modalUserInput.focus();
                }
            };

            modalSendBtn.addEventListener('click', handleModalSend);
            modalUserInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleModalSend();
                }
            });

            closeModalBtn.addEventListener('click', () => modalOverlay.classList.add('hidden'));
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
